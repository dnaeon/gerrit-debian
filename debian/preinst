#!/bin/sh
# preinst script for gerrit
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <new-preinst> `install'
#        * <new-preinst> `install' <old-version>
#        * <new-preinst> `upgrade' <old-version>
#        * <old-preinst> `abort-upgrade' <new-version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package


case "$1" in
       install|upgrade)

	# If the package has default file it could be sourced, so that
	# the local admin can overwrite the defaults

	[ -f "/etc/default/gerrit" ] && . /etc/default/gerrit

	# Sane defaults:

	[ -z "$GERRIT_HOME" ] && GERRIT_HOME=/home/gerrit
	[ -z "$GERRIT_USER" ] && GERRIT_USER=gerrit
	[ -z "$GERRIT_FULLNAME" ] && GERRIT_FULLNAME="Gerrit Daemon User"
	[ -z "$GERRIT_GROUP" ] && GERRIT_GROUP=gerrit

	# Groups that the user will be added to, if undefined, then none.
	ADDGROUP=""

	# create user to avoid running server as root
	# 1. create group if not existing
	if ! getent group | grep -q "^$GERRIT_GROUP:" ; then
		echo -n "Adding group $GERRIT_GROUP.."
		addgroup --quiet --system $GERRIT_GROUP 2>/dev/null || true
		echo "..done"
	fi
	# 2. create homedir if not existing
	test -d $GERRIT_HOME || mkdir $GERRIT_HOME
	# 3. create user if not existing
	if ! getent passwd | grep -q "^$GERRIT_USER:"; then
		echo -n "Adding system user $GERRIT_USER.."
		adduser --quiet \
			 --system \
			--ingroup $GERRIT_GROUP \
			--no-create-home \
			--disabled-password \
		    	--shell /bin/false \
			$GERRIT_USER 2>/dev/null || true
		echo "..done"
	fi
       # 4. adjust passwd entry
	usermod -c "$GERRIT_FULLNAME" \
		-d $GERRIT_HOME   \
		-g $GERRIT_GROUP  \
                  $GERRIT_USER
	# 5. adjust file and directory permissions
	if ! dpkg-statoverride --list $GERRIT_HOME >/dev/null
	then
		chown -R $GERRIT_USER:${GERRIT_GROUP} $GERRIT_HOME
		chmod u=rwx,g=rxs,o= $GERRIT_HOME
	fi
	# 6. Add the user to the ADDGROUP group
	if test -n "$ADDGROUP"
	then
		if ! groups $GERRIT_USER | cut -d: -f2 | \
		grep -qw $ADDGROUP; then
			adduser $GERRIT_USER $ADDGROUP
		fi
	fi
	;;
	abort-upgrade)
	;;

    *)
        echo "preinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
